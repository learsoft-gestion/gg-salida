<!DOCTYPE html>
<html xml:lang="es" lang="es">

<head>
  <title>Generador de Informes</title>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    .form-group {
      margin-bottom: 20px;
    }

    th {
      text-align: center;
    }

    tbody td {
      text-align: center;
    }

    .centrado {
      display: flex;
      align-items: flex-end;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <h3 class="mt-5">Generador de Informes</h3>

    <div class="row">
      <div class="col-md-2 form-group">
        <label for="convenio">Convenio</label>
        <select id="conv" class="form-control">
          <option value="" disabled selected>Selecciona una opción</option>
        </select>
      </div>
      <div class="col-md-2 form-group">
        <label for="empresa">Empresa</label>
        <select id="emp" class="form-control">
          <option value="" disabled selected>Selecciona una opción</option>
        </select>
      </div>
      <div class="col-md-2 form-group">
        <label for="concepto">Concepto</label>
        <select id="conc" class="form-control">
          <option value="" disabled selected>Selecciona una opción</option>
        </select>
      </div>
      <div class="col-md-2 form-group">
        <label for="tipo">Tipo</label>
        <select id="tipo" class="form-control">
          <option value="" disabled selected>Selecciona una opción</option>
        </select>
      </div>
      <div class="col-md-1 form-group">
        <label>Procesado:</label><br>
        <input type="checkbox" id="procesadoTrue"> Sí
        <input type="checkbox" id="procesadoFalse"> No
      </div>
      <!-- Campo de fecha -->
      <div class="col-md-1 form-group">
        <label for="filtroFechaInicio">Desde</label>
        <input id="filtroFechaInicio" class="form-control" placeholder="Selecciona una fecha" data-input>
      </div>
      <!-- Campo de fecha final para el período -->
      <div class="col-md-1 form-group">
        <label for="filtroFechaFin">Hasta</label>
        <input id="filtroFechaFin" class="form-control" placeholder="Selecciona hasta" data-input>
      </div>
      <div class="col-md-1 form-group centrado">
        <button type="button" class="btn btn-primary" id="btnBuscar">Buscar</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped" id="tablaDatos" style="display: none;">
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Concepto</th>
            <th>Tipo</th>
            <th>Jurisdicción</th>
            <th>Nombre de Salida</th>
            <th>Versión</th>
            <th>Última ejecución</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // Llenar fecha hasta = fecha desde
    $(document).ready(function () {
      // Filtro de fecha/período
      $('#filtroFechaInicio').on('change', function () {
        if ($("#filtroFechaFin").val() === '') {
          $("#filtroFechaFin").val($(this).val());
        }
      });

      // Inicializar calendario Flatpickr
      flatpickr("#filtroFechaInicio, #filtroFechaFin", {
        dateFormat: "Ym",
        locale: 'es',
      });
    });

    // Select de convenio
    $.ajax({
      url: '/convenios',
      method: 'GET',
      dataType: 'json',
      success: function (data) {
        if (data && data.length > 0) {
          data.forEach(convenio => {
            const option = document.createElement("option");
            option.value = convenio.id;
            option.textContent = convenio.nombre;
            $("#conv").append(option);
          });
        } else {
          console.log('No se recibieron datos del servidor.');
        }
      },
      error: function (error) {
        console.error('Error en la búsqueda:', error);
      }
    });

    // Select de empresa
    $("#conv").change(function () {
      var convId = $("#conv").val();

      $.ajax({
        url: `/empresas/${convId}`,
        method: 'GET',
        dataType: 'json',
        success: function (data) {
          $("#emp").empty();
          var selOption = document.createElement("option");
          selOption.value = '';
          selOption.textContent = 'Selecciona una opción';
          $("#emp").append(selOption);
          if (data && data.length > 0) {
            data.forEach(empresa => {
              const option = document.createElement("option");
              option.value = empresa.id;
              option.textContent = empresa.nombre;
              $("#emp").append(option);
            });
          } else {
            console.log('No se recibieron datos del servidor.');
          }
        },
        error: function (error) {
          console.error('Error en la búsqueda:', error);
        }
      });
    });

    // Select de concepto y tipo
    $("#emp").change(function () {
      var convId = $("#conv").val();
      var empId = $("#emp").val();

      $.ajax({
        url: `/conceptos/${convId}/${empId}`,
        method: 'GET',
        dataType: 'json',
        success: function (data) {
          $("#conc").empty();
          $("#tipo").empty();
          var selOption = document.createElement("option");
          selOption.value = '';
          selOption.textContent = 'Selecciona una opción';
          $("#conc").append(selOption);
          var selOption2 = document.createElement("option");
          selOption2.value = '';
          selOption2.textContent = 'Selecciona una opción';
          $("#tipo").append(selOption2);
          if (data) {
            data.Conceptos.forEach(concepto => {
              const option = document.createElement("option");
              option.value = concepto.Id;
              option.textContent = concepto.Nombre;
              $("#conc").append(option);
            });
            data.Tipos.forEach(tipo => {
              const option = document.createElement("option");
              option.value = tipo.Id;
              option.textContent = tipo.Nombre;
              $("#tipo").append(option);
            });
          } else {
            console.log('No se recibieron datos del servidor.');
          }
        },
        error: function (error) {
          console.error('Error en la búsqueda:', error);
        }
      });
    });

    // Botón buscar
    $("#btnBuscar").click(function () {
      // Obtengo todos los valores de los campos en variables
      var conv = $("#conv").val();
      var fechaDesde = $("#filtroFechaInicio").val();
      var fechaHasta = $("#filtroFechaFin").val();
      var json = {
        convenio: conv,
        empresa: $("#emp").val(),
        concepto: $("#conc").val(),
        tipo: $("#tipo").val(),
        fecha1: fechaDesde,
        fecha2: fechaHasta
      }
      var procesadoTrue = $('#procesadoTrue').is(':checked');
      var procesadoFalse = $('#procesadoFalse').is(':checked');

      if (!(procesadoTrue && procesadoFalse)) {
        if (procesadoTrue || procesadoFalse) {
          json.procesado = procesadoTrue ? true : false;
        }
      }
      // Validaciones de campos obligatorios y fechas
      if (!(conv && fechaDesde && fechaHasta)) {
        alert("Faltan completar campos");
        return;
      } else if (!(fechaHasta >= fechaDesde)) {
        alert("La fecha Hasta no puede ser menor a la fecha de inicio");
        return;
      }

      // Llamada al servidor
      $.ajax({
        url: `/procesos`,
        method: 'GET',
        dataType: 'json',
        data: json,
        success: function (data) {
          if (data && data.length > 0) {
            llenarTabla(data);
          } else {
            console.log('No se recibieron datos del servidor.');
          }
        },
        error: function (error) {
          console.error('Error en la búsqueda:', error);
        }
      });
    });

    // Función para llenar la tabla
    llenarTabla = function (data) {
      $("#tablaDatos").show();
      var tbody = $('table tbody');
      tbody.empty();

      $.each(data, function (index, item) {
        var row = $('<tr>');
        row.append('<td>' + item.Empresa + '</td>');
        row.append('<td>' + item.Concepto + '</td>');
        row.append('<td>' + item.Tipo + '</td>');
        row.append('<td>' + item.Nombre + '</td>');
        row.append('<td>' + item.Nombre_salida.String + '</td>');
        row.append('<td>' + item.Version.Int16 + '</td>');
        row.append('<td>' + item.Ultima_ejecucion.String + '</td>');

        tbody.append(row);
      });
    }
  </script>
</body>

</html>