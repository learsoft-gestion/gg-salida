<!DOCTYPE html>
<html xml:lang="es" lang="es">

<head>
  <title>Generador de Informes</title>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.min.js"></script>
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.min.css">
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.es.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="stylesheet" href="/static/css/styles.css">
  <!-- <style>
    body {
      font-family: Arial, sans-serif;
      padding: 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    th {
      text-align: center;
    }

    tbody td {
      text-align: center;
    }

    .table td {
      padding: 0;
      vertical-align: middle;
    }

    .table th {
      vertical-align: middle;
    }

    .btn-buscar {
      display: flex;
      align-items: flex-end;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.5);
      z-index: 9999;
      display: none;
    }

    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #mensajeFaltantes {
      position: relative;
      top: 90px;
      padding: 5px;
    }

    #filtros {
      z-index: 10;
    }

    #mensajeFaltantes {
      display: none;
      z-index: 0;
    }

    #mensaje {
      margin-bottom: 0;
      font-size: 14px;
    }

    #btnGenerar {
      display: none;
      padding: 3px;
      font-size: 14px;
    }

    .hiddenRow {
      padding: 0 !important;
    }
  </style> -->
</head>

<body>
  <div class="container-fluid" style="overflow-x: hidden;">
    <div class="row bg-dark text-white position-fixed" id="filtros" style="width: 100%;">
      <div class="col-md-8">
        <div class="row">
          <div class="col form-group">
            <label for="convenio">Convenio</label>
            <select id="conv" class="form-control">
              <option value="" disabled selected>Selecciona una opción</option>
            </select>
          </div>
          <div class="col form-group">
            <label for="empresa">Empresa</label>
            <select id="emp" class="form-control">
              <option value="" disabled selected>Todas</option>
            </select>
          </div>
          <div class="col form-group">
            <label for="concepto">Concepto</label>
            <select id="conc" class="form-control">
              <option value="" disabled selected>Todos</option>
            </select>
          </div>
          <div class="col form-group">
            <label for="tipo">Tipo</label>
            <select id="tipo" class="form-control">
              <option value="" disabled selected>Todos</option>
            </select>
          </div>
          <div class="col form-group">
            <label for="jurisdiccion">Jurisdicción</label>
            <input type="text" id="jurisdiccion" class="form-control" placeholder="Todas">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="row">
          <div class="col form-group">
            <label for="filtroFechaInicio">Desde</label>
            <input id="filtroFechaInicio" class="form-control" placeholder="Selecciona desde" data-input>
          </div>
          <div class="col form-group">
            <label for="filtroFechaFin">Hasta</label>
            <input id="filtroFechaFin" class="form-control" placeholder="Selecciona hasta" data-input>
          </div>
          <div class="col-md-3 form-group">
            <label>Procesado</label><br>
            <input type="checkbox" id="procesadoTrue"> Sí
            <input type="checkbox" id="procesadoFalse"> No
          </div>
          <div class="col-md-2 form-group btn-buscar">
            <button type="button" class="btn btn-outline-light" id="btnBuscar" title="Buscar">
              <i class="material-symbols-outlined">search</i>
            </button>
          </div>
        </div>
      </div>
      <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
      </div>
    </div>
    <div class="alert-dark align-middle row" id="mensajeFaltantes">
      <div class="row">
        <div class="ml-5 pt-1">
          <p id="mensaje"></p>
        </div>
        <div class="ml-4">
          <button type="button" class="btn btn-danger" id="btnGenerar">Generar</button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-condensed table-striped" style="margin-top: 95px; display: none;" id="tablaDatos">
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Concepto</th>
            <th>Tipo</th>
            <th>Jurisdicción</th>
            <th>Nombre de Salida</th>
            <th>Versión</th>
            <th>Última ejecución</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="/static/js/main.js"></script>
  <!-- <script>
    // Chequear los checkbox
    $('[type=checkbox]').prop('checked', true);

    // Llenar fecha hasta = fecha desde
    $(document).ready(function () {
      // Filtro de fecha/período
      $('#filtroFechaInicio').on('change', function () {
        if ($("#filtroFechaFin").val() === '') {
          $("#filtroFechaFin").val($(this).val());
        }
      });

      $("#filtroFechaInicio, #filtroFechaFin").datepicker({
        autoclose: true,
        minViewMode: 1,
        format: 'mm/yyyy',
        language: "es"
      });

    });

    // Select de convenio
    $.ajax({
      url: '/convenios',
      method: 'GET',
      dataType: 'json',
      success: function (data) {
        if (data && data.length > 0) {
          data.forEach(convenio => {
            const option = document.createElement("option");
            option.value = convenio.id;
            option.textContent = convenio.nombre;
            $("#conv").append(option);
          });
        } else {
          console.log('No se recibieron datos del servidor.');
        }
      },
      error: function (error) {
        console.error('Error en la búsqueda:', error);
      }
    });

    // Select de empresa
    $("#conv").change(function () {
      var convId = $("#conv").val();

      $.ajax({
        url: `/empresas/${convId}`,
        method: 'GET',
        dataType: 'json',
        success: function (data) {
          $("#emp").empty();
          var selOption = document.createElement("option");
          selOption.value = '';
          selOption.textContent = 'Todas';
          $("#emp").append(selOption);
          if (data && data.length > 0) {
            data.forEach(empresa => {
              const option = document.createElement("option");
              option.value = empresa.id;
              option.textContent = empresa.nombre;
              $("#emp").append(option);
            });
          } else {
            console.log('No se recibieron datos del servidor.');
          }
        },
        error: function (error) {
          console.error('Error en la búsqueda:', error);
        }
      });
    });

    // Select de concepto y tipo
    $("#emp").change(function () {
      var convId = $("#conv").val();
      var empId = $("#emp").val();

      $.ajax({
        url: `/conceptos/${convId}/${empId}`,
        method: 'GET',
        dataType: 'json',
        success: function (data) {
          $("#conc").empty();
          $("#tipo").empty();
          var selOption = document.createElement("option");
          selOption.value = '';
          selOption.textContent = 'Todos';
          $("#conc").append(selOption);
          var selOption2 = document.createElement("option");
          selOption2.value = '';
          selOption2.textContent = 'Todos';
          $("#tipo").append(selOption2);
          if (data) {
            data.Conceptos.forEach(concepto => {
              const option = document.createElement("option");
              option.value = concepto.Id;
              option.textContent = concepto.Nombre;
              $("#conc").append(option);
            });
            data.Tipos.forEach(tipo => {
              const option = document.createElement("option");
              option.value = tipo.Id;
              option.textContent = tipo.Nombre;
              $("#tipo").append(option);
            });
          } else {
            console.log('No se recibieron datos del servidor.');
          }
        },
        error: function (error) {
          console.error('Error en la búsqueda:', error);
        }
      });
    });

    // Botón buscar
    $("#btnBuscar").click(function () {
      // Obtengo todos los valores de los campos en variables
      var conv = $("#conv").val();
      var fechaDesde = $("#filtroFechaInicio").val();
      var fechaHasta = $("#filtroFechaFin").val();
      var json = {
        convenio: conv,
        empresa: $("#emp").val(),
        concepto: $("#conc").val(),
        tipo: $("#tipo").val(),
        jurisdiccion: $("#jurisdiccion").val(),
        fecha1: fechaDesde,
        fecha2: fechaHasta
      }
      var procesadoTrue = $('#procesadoTrue').is(':checked');
      var procesadoFalse = $('#procesadoFalse').is(':checked');

      if (!(procesadoTrue && procesadoFalse)) {
        if (procesadoTrue || procesadoFalse) {
          json.procesado = procesadoTrue ? true : false;
        }
      }
      // Validaciones de campos obligatorios y fechas
      if (!(conv && fechaDesde && fechaHasta)) {
        alert("Faltan completar campos");
        return;
      } else if (!(fechaHasta >= fechaDesde)) {
        alert("La fecha Hasta no puede ser menor a la fecha de inicio");
        return;
      }
      // Muestro mensaje de archivos por generar
      mostrarMensaje(json);
      // Llamada al servidor para mostrar tabla
      $.ajax({
        url: `/procesos`,
        method: 'GET',
        dataType: 'json',
        data: json,
        success: function (data) {
          if (data && data.length > 0) {
            llenarTabla(data);
          } else {
            $("#tablaDatos").hide();
            $("#mensajeFaltantes").hide();
            alert("No hubo resultados para su búsqueda");
            console.log('No se recibieron datos del servidor.');
          }
        },
        error: function (error) {
          console.error('Error en la búsqueda:', error);
        }
      });
    });

    mostrarMensaje = function (json) {
      $.ajax({
        url: '/restantes',
        method: 'GET',
        dataType: 'json',
        data: json,
        success: function (data) {
          if (data) {
            $("#mensajeFaltantes").show();
            $("#mensaje").text(data.mensaje);
            if (data.boton) {
              $("#btnGenerar").show();
            } else {
              $("#btnGenerar").hide();
            }
          } else {
            console.log('No se recibieron datos del servidor.');
          }
        },
        error: function (error) {
          console.error('Error en la búsqueda:', error);
        }
      });
    }

    // Función para llenar la tabla
    llenarTabla = function (rawData) {
      data = reordenarData(rawData);
      $("#tablaDatos").show();
      var tbody = $('table tbody');
      tbody.empty();
      $.each(data, function (index, item) {
        $.each(item, function (i, proceso) {
          if (i === 0) {
            var row = $(`<tr data-toggle="collapse" class="accordion-toggle">`);
            row.append('<td>' + proceso.Empresa + '</td>');
            row.append('<td>' + proceso.Concepto + '</td>');
            row.append('<td>' + proceso.Tipo + '</td>');
            row.append('<td>' + proceso.Nombre + '</td>');
            row.append(`<td title="${proceso.Nombre_salida.String}">${obtenerNombreArchivo(proceso.Nombre_salida.String)}</td>`);
            if (proceso.Ultima_version) {
              row.append(`<td><button class="btn btn-default btn-sm openOculto" data-target="#${proceso.Id}"><span class="material-symbols-outlined">arrow_drop_down</span></button>${proceso.Version}</td>`)
            } else {
              row.append('<td>' + proceso.Version + '</td>')
            }
            row.append('<td>' + proceso.Ultima_ejecucion + '</td>');
            row.append('<td>' + generarBoton(proceso) + '</td>');

            tbody.append(row);
            if (proceso.Ultima_version) {
              var subtabla = armarSubtabla(proceso.Id);
              tbody.append(subtabla);
            }
          } else {
            var subTbody = $(`#tbody-${proceso.Id}`);
            var subRow = $('<tr>');
            subRow.append(`<td title="${proceso.Nombre_salida.String}">${obtenerNombreArchivo(proceso.Nombre_salida.String)}</td>`);
            subRow.append('<td>' + proceso.Version + '</td>');
            subRow.append('<td>' + proceso.Ultima_ejecucion + '</td>');

            subTbody.append(subRow);
          }
        });
      });

      $("tr.accordion-toggle .openOculto").on('click', function () {
        id = $(this).attr("data-target");
        $(id).toggleClass("collapse");
      });

      // Botones de lanzar y relanzar
      $('.lanzar').click(function () {
        $('#loadingOverlay').show();

        var id = $(this).val();
        var json = {
          Id: $(this).val(),
          Fecha: $("#filtroFechaInicio").val(),
          Fecha2: $("#filtroFechaFin").val()
        }

        $.ajax({
          url: '/send',
          method: 'POST',
          dataType: 'json',
          data: JSON.stringify(json),
          success: function (data) {
            $('#loadingOverlay').hide();
            if (data) {
              alert(data.mensaje);
              $("#btnBuscar").trigger("click");
            } else {
              console.log('No se recibieron datos del servidor.');
            }
          },
          error: function (error) {
            $('#loadingOverlay').hide();
            console.error('Error en la solicitud:', error);
          }
        });
      });
    }

    reordenarData = function (rawData) {
      const data = {};

      rawData.forEach(item => {
        const id = item.Id;
        if (!data[id]) {
          data[id] = [];
        }
        data[id].push(item);
      });

      return data;
    }

    obtenerNombreArchivo = function (nombre) {
      nombre = nombre.split("\\");
      return nombre[nombre.length - 1];
    }

    generarBoton = function (item) {
      if (item.Boton === "lanzar") {
        return `<button type="button" class="btn btn-success btn-sm lanzar" value="${item.Id}" title="Lanzar"><i class="material-icons">play_arrow</i></button>`;
      } else if (item.Boton === "relanzar") {
        return `<button type="button" class="btn btn-primary btn-sm lanzar" value="${item.Id}" title="Relanzar"><i class="material-icons">refresh</i></button>`;
      }
      return '<button type="button" class="btn btn-transparent" style="width: 38px; height: 38px;" disabled></button>';
    }

    armarSubtabla = function (id) {
      var hiddenRow = $('<tr>');
      var td = $('<td colspan="10" class="hiddenRow">');
      var div = $(`<div class="accordian-body collapse" id="${id}">`);
      var table = $('<table class="table">');
      var tbody2 = $(`<tbody id="tbody-${id}">`)
      var tr = $('<tr>');
      tr.append('<th>Nombre de salida</th>');
      tr.append('<th>Versión</th>');
      tr.append('<th>Última ejecución</th>');
      table.append(tr);
      table.append(tbody2);
      div.append(table);
      td.append(div);
      hiddenRow.append(td);

      return hiddenRow;
    }

    // Botón Generar documentos
    $("#btnGenerar").click(function () {
      $('#loadingOverlay').show();

      $.ajax({
        url: '/multiple',
        method: 'POST',
        dataType: 'json',
        success: function (data) {
          $('#loadingOverlay').hide();
          if (data) {
            alert(data.mensaje);
            $("#btnBuscar").trigger("click");
          } else {
            console.log('No se recibieron datos del servidor.');
          }
        },
        error: function (error) {
          $('#loadingOverlay').hide();
          console.error('Error en la solicitud:', error);
        }
      });
    });
  </script> -->
</body>

</html>